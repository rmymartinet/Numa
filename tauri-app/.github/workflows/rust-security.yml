name: ðŸ¦€ Rust Security & Quality

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'src-tauri/**'
      - '.github/workflows/rust-security.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src-tauri/**'
      - '.github/workflows/rust-security.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rust-security-audit:
    name: ðŸ” Security & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ðŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: rust-security-${{ runner.os }}

      - name: ðŸŽ¯ Install security tools
        run: |
          cargo install --locked cargo-audit
          cargo install --locked cargo-deny

      # === FORMATTING ===
      - name: ðŸ“ Check code formatting
        run: |
          cd src-tauri
          cargo fmt --all -- --check
        continue-on-error: false

      # === LINTING avec rÃ¨gles de sÃ©curitÃ© ===
      - name: ðŸ”§ Clippy with security lints
        run: |
          cd src-tauri
          cargo clippy --all-targets --all-features --locked -- \
            -D warnings \
            -W clippy::pedantic \
            -W clippy::nursery \
            -W clippy::cargo \
            -W clippy::suspicious \
            -W clippy::complexity \
            -A clippy::uninlined-format-args \
            -A clippy::module-name-repetitions
        continue-on-error: false

      # === TESTS avec diffÃ©rentes features ===
      - name: ðŸ§ª Test default features
        run: |
          cd src-tauri
          cargo test --locked --verbose

      - name: ðŸ§ª Test dev features
        run: |
          cd src-tauri
          cargo test --locked --features dev --verbose

      - name: ðŸ§ª Test debug features
        run: |
          cd src-tauri
          cargo test --locked --features debug --verbose
          
      - name: ðŸ§ª Test secure build (no private APIs)
        run: |
          cd src-tauri
          cargo test --locked --no-default-features --features secure --verbose

      # === BUILDS de validation ===
      - name: ðŸ—ï¸ Validate feature combinations
        run: |
          cd src-tauri
          echo "Testing secure build..."
          cargo check --locked --no-default-features --features secure
          
          echo "Testing stealth_macos build..."
          cargo check --locked --features stealth_macos
          
          echo "Testing dev build..."
          cargo check --locked --features dev
          
          echo "Testing debug build..."
          cargo check --locked --features debug

      # === AUDIT SÃ‰CURITÃ‰ ===
      - name: ðŸ›¡ï¸ Security audit - vulnerabilities
        run: |
          cd src-tauri
          cargo audit --deny warnings --deny yanked --deny unsound
        continue-on-error: false

      - name: ðŸ›¡ï¸ Dependency policy check
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          manifest-path: src-tauri/Cargo.toml
          arguments: --all-features
          
      # === DOC GENERATION ===
      - name: ðŸ“š Check documentation
        run: |
          cd src-tauri
          cargo doc --no-deps --document-private-items --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"

  # === JOB SÃ‰PARÃ‰ pour macOS-specific tests ===
  macos-stealth-tests:
    name: ðŸŽ macOS Stealth Features
    runs-on: macos-latest
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'macos')
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: ðŸ•µï¸ Test stealth_macos feature compilation
        run: |
          cd src-tauri
          echo "Testing stealth_macos feature on actual macOS..."
          cargo check --features stealth_macos --verbose
          
          echo "Testing stealth_macos + dev features..."
          cargo check --features "stealth_macos,dev" --verbose
          
          echo "Running stealth-specific tests..."
          cargo test --features stealth_macos stealth --verbose

      - name: ðŸ§ª Platform-specific tests
        run: |
          cd src-tauri
          cargo test --features stealth_macos platform::macos --verbose || echo "Platform tests completed"

  # === RAPPORT de sÃ©curitÃ© ===
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [rust-security-audit]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ¦€ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: ðŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: ðŸ“Š Generate security report
        run: |
          cd src-tauri
          echo "# ðŸ›¡ï¸ Numa Security Report" > security-report.md
          echo "Generated: $(date)" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ“¦ Dependencies" >> security-report.md
          cargo tree --locked >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ” Features Analysis" >> security-report.md
          echo "- Default features: stealth_macos" >> security-report.md
          echo "- Secure build: no private APIs" >> security-report.md
          echo "- Dev features: test + stealth capabilities" >> security-report.md
          echo "" >> security-report.md
          
          cargo install cargo-audit || true
          echo "## ðŸš¨ Security Audit" >> security-report.md
          cargo audit --format json > audit.json || true
          if [ -f audit.json ]; then
            echo "âœ… No known vulnerabilities detected" >> security-report.md
          fi

      - name: ðŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: src-tauri/security-report.md